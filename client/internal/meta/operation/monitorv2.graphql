# definitions of monitor v2 data

fragment MonitorV2Comparison on MonitorV2Comparison {
    compareFn
    # @genqlient(flatten: true)
    compareValue {
        ...PrimitiveValue
    }
}

fragment MonitorV2ColumnPath on MonitorV2ColumnPath {
    name
    path
}

fragment MonitorV2LinkColumnMeta on MonitorV2LinkColumnMeta {
    # @genqlient(flatten: true)
    srcFields {
        ...MonitorV2ColumnPath
    }
    dstFields
    targetDataset
}

fragment MonitorV2LinkColumn on MonitorV2LinkColumn {
    name
    # @genqlient(flatten: true)
    meta {
        ...MonitorV2LinkColumnMeta
    }
}

fragment MonitorV2Column on MonitorV2Column {
    # @genqlient(flatten: true)
    linkColumn {
        ...MonitorV2LinkColumn
    }
    # @genqlient(flatten: true)
    columnPath {
        ...MonitorV2ColumnPath
    }
}

fragment MonitorV2ColumnComparison on MonitorV2ColumnComparison {
    # @genqlient(flatten: true)
    column {
        ...MonitorV2Column
    }
    # @genqlient(flatten: true)
    compareValues {
        ...MonitorV2Comparison
    }
}

fragment MonitorV2CountRule on MonitorV2CountRule {
    # @genqlient(flatten: true)
    compareValues {
        ...MonitorV2Comparison
    }
    # @genqlient(flatten: true)
    compareGroups {
        ...MonitorV2ColumnComparison
    }
}

fragment MonitorV2ThresholdRule on MonitorV2ThresholdRule {
    # @genqlient(flatten: true)
    compareValues {
        ...MonitorV2Comparison
    }
    valueColumnName
    aggregation
    # @genqlient(flatten: true)
    compareGroups {
        ...MonitorV2ColumnComparison
    }
}

fragment MonitorV2PromoteRule on MonitorV2PromoteRule {
    # @genqlient(flatten: true)
    compareColumns {
        ...MonitorV2ColumnComparison
    }
}

fragment MonitorV2NoDataRule on MonitorV2NoDataRule {
    expiration
    # @genqlient(flatten: true)
    threshold {
        ...MonitorV2ThresholdRule
    }
}

fragment MonitorV2Rule on MonitorV2Rule {
    level
    # @genqlient(flatten: true)
    count {
        ...MonitorV2CountRule
    }
    # @genqlient(flatten: true)
    threshold {
        ...MonitorV2ThresholdRule
    }
    # @genqlient(flatten: true)
    promote {
        ...MonitorV2PromoteRule
    }
}

fragment MonitorV2Definition on MonitorV2Definition{
    inputQuery {
        outputStage
        # @genqlient(flatten: true)
        stages {
            ...StageQuery
        }
    }
    # @genqlient(flatten: true)
    noDataRules {
        ...MonitorV2NoDataRule
    }
    # @genqlient(flatten: true)
    rules {
        ...MonitorV2Rule
    }
    lookbackTime
    dataStabilizationDelay
    maxAlertsPerHour
    # @genqlient(flatten: true)
    groupings {
        ...MonitorV2Column
    }
    # @genqlient(flatten: true)
    scheduling {
        ...MonitorV2Scheduling
    }
    customVariables
}

fragment MonitorV2IntervalSchedule on MonitorV2IntervalSchedule {
    interval
    randomize
}

fragment MonitorV2TransformSchedule on MonitorV2TransformSchedule {
    freshnessGoal
}

fragment MonitorV2CronSchedule on MonitorV2CronSchedule {
    rawCron
    timezone
}

fragment MonitorV2Scheduling on MonitorV2Scheduling {
    # @genqlient(flatten: true)
    interval {
        ...MonitorV2IntervalSchedule
    }
    # @genqlient(flatten: true)
    transform {
        ...MonitorV2TransformSchedule
    }
    # @genqlient(flatten: true)
    scheduled {
        ...MonitorV2CronSchedule
    }
}

fragment MonitorV2SearchResult on MonitorV2SearchResult {
    # @genqlient(flatten: true)
    results {
        ...MonitorV2
    }
}

fragment MonitorV2ActionRule on MonitorV2ActionRule {
    actionID
    levels
    # @genqlient(flatten: true)
    conditions {
        ...MonitorV2ComparisonExpression
    }
    sendEndNotifications
    sendRemindersInterval
    # @genqlient(flatten: true)
    definition {
        ...MonitorV2ActionDefinition
    }
}

fragment MonitorV2ActionDefinition on MonitorV2ActionDefinition {
    inline
    type
    # @genqlient(flatten: true)
    email {
        ...MonitorV2EmailAction
    }
    # @genqlient(flatten: true)
    webhook {
        ...MonitorV2WebhookAction
    }
}

fragment MonitorV2ComparisonExpression on MonitorV2ComparisonExpression {
    # @genqlient(flatten: true)
    compareTerms {
        ...MonitorV2ComparisonTerm
    }
    operator
    # subExpressions are not used by the UI so we won't support them here yet either
}

fragment MonitorV2ComparisonTerm on MonitorV2ComparisonTerm {
    # @genqlient(flatten: true)
    comparison {
        ...MonitorV2Comparison
    }
    # @genqlient(flatten: true)
    column {
        ...MonitorV2Column
    }
}

fragment MonitorV2 on MonitorV2 {
    id
    workspaceId
    createdBy
    createdDate
    name
    iconUrl
    description
    disabled
    managedById
    rollupStatus
    ruleKind
    # @genqlient(flatten: true)
    definition {
        ...MonitorV2Definition
    }
    # @genqlient(flatten: true)
    actionRules {
        ...MonitorV2ActionRule
    }
}

# definitions of monitorv2 CRUD ops

mutation createMonitorV2(
	$workspaceId: ObjectId!,
	$input: MonitorV2Input!
) {
    # @genqlient(flatten: true)
	monitorV2: createMonitorV2(workspaceId:$workspaceId, input:$input) {
        ...MonitorV2
	}
}

mutation updateMonitorV2(
	$id: ObjectId!,
	$input: MonitorV2Input!
) {
	# @genqlient(flatten: true)
	monitorV2: updateMonitorV2(id:$id, input:$input) {
        ...MonitorV2
	}
}

query getMonitorV2($id: ObjectId!) {
    # @genqlient(flatten: true)
	monitorV2: monitorV2(id: $id) {
		...MonitorV2
	}
}

mutation deleteMonitorV2($id: ObjectId!) {
    # @genqlient(flatten: true)
	resultStatus: deleteMonitorV2(id: $id) {
        ...ResultStatus
	}
}

query lookupMonitorV2($workspaceId: ObjectId, $folderId: ObjectId, $nameExact: String, $nameSubstring: String) {
    # @genqlient(flatten: true)
    monitorV2s: searchMonitorV2(workspaceId: $workspaceId, folderId: $folderId, nameExact: $nameExact, nameSubstring: $nameSubstring) {
        ...MonitorV2SearchResult
    }
}

mutation saveMonitorV2Relations(
    $monitorId: ObjectId!, 
    $actionRelations: [ActionRelationInput!]
) {
    # @genqlient(flatten: true)
    monitorV2: saveMonitorV2Relations(monitorId: $monitorId, actionRelations: $actionRelations) {
        ...MonitorV2
    }
}

mutation saveMonitorV2WithActions(
    $workspaceId: ObjectId!,
    $monitorId: ObjectId,
    $input: MonitorV2Input!,
    $actions: [MonitorV2ActionAndRelationInput!],
) {
    # @genqlient(flatten: true)
    monitorV2: saveMonitorV2WithActions(
        workspaceId: $workspaceId,
        monitorId: $monitorId,
        input: $input,
        actions: $actions,
    ) {
        ...MonitorV2
    }
}

